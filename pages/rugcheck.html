<div class="header">
  <div class="title">
   <div class="logodob"><img src="img/dob.png"  width="70px" height="70px"></div>
    <div>
      <h1>Rug Check</h1>
      <div class="sub">Security analysis & risk assessment</div>
    </div>
  </div>
</div>

<div class="card">
  <!-- SolSniffer + Dobby AI Section -->
<div class="solsniffer-section">
  <style>
    .solsniffer-section{max-width:820px;margin:32px auto;padding:32px;border-radius:16px;background:#ffffff;box-shadow:0 4px 6px rgba(0,0,0,0.07),0 12px 24px rgba(0,0,0,0.08);border:2px solid #000000}
    .solsniffer-section h2{margin:0 0 12px;font-size:28px;color:#000000;font-weight:800;letter-spacing:-0.5px}
    .solsniffer-section p.lead{margin:0 0 24px;color:#333333;font-size:15px;line-height:1.6}
    .solsniffer-section .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:20px}
    .solsniffer-section input[type="text"]{flex:1;min-width:100%;padding:14px 18px;border-radius:12px;border:2px solid #000000;background:#ffffff;color:#000000;font-size:15px;font-weight:500;transition:all 0.2s}
    .solsniffer-section input[type="text"]:focus{outline:none;border-color:#000000;box-shadow:0 0 0 3px rgba(0,0,0,0.1)}
    .solsniffer-section button{background:#000000;border:2px solid #000000;padding:14px 24px;border-radius:12px;color:#ffffff;font-weight:700;cursor:pointer;font-size:15px;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.5px}
    .solsniffer-section button:hover{background:#333333;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    .solsniffer-section button:active{transform:translateY(0)}
    .solsniffer-section button:disabled{opacity:0.4;cursor:not-allowed;transform:none}
    .solsniffer-section button.ghost{background:#ffffff;border:2px solid #000000;color:#000000}
    .solsniffer-section button.ghost:hover{background:#f5f5f5}
    .solsniffer-section .result{margin-top:28px;padding:0;border-radius:12px;background:#ffffff;display:none;animation:fadeIn 0.4s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .solsniffer-section .badge{display:inline-block;padding:8px 16px;border-radius:8px;font-weight:700;font-size:14px;border:2px solid #000000;margin-bottom:20px}
    .solsniffer-section .safe{background:#ffffff;color:#000000;border-color:#22c55e}
    .solsniffer-section .risk{background:#ffffff;color:#000000;border-color:#ef4444}
    .solsniffer-section .warning{background:#ffffff;color:#000000;border-color:#fbbf24}
    .solsniffer-section .note{margin-top:16px;color:#666666;font-size:13px}
    .solsniffer-section .analysis-section{margin-top:24px;padding:28px;border-radius:12px;background:#ffffff;border:2px solid #000000}
    .solsniffer-section .analysis-section h3{margin:0 0 20px;font-size:20px;color:#000000;font-weight:800;display:flex;align-items:center;gap:10px}
    .solsniffer-section .analysis-content{line-height:1.8;color:#000000;font-size:15px}
    .solsniffer-section .analysis-content strong{font-weight:800;text-transform:uppercase;letter-spacing:0.3px;color:#000000}
    .solsniffer-section .analysis-content p{margin:0 0 16px}
    .solsniffer-section .analysis-content p:last-child{margin:0}
    .solsniffer-section .analysis-content h4{font-size:16px;font-weight:800;margin:20px 0 10px;color:#000000;text-transform:uppercase;letter-spacing:0.5px}
    .solsniffer-section .analysis-content ul{margin:8px 0;padding-left:24px}
    .solsniffer-section .analysis-content li{margin:6px 0;color:#000000}
    .solsniffer-section .loading-dots{display:inline-flex;gap:6px;align-items:center}
    .solsniffer-section .loading-dots span{width:8px;height:8px;border-radius:50%;background:#000000;animation:bounce-dots 1.4s infinite ease-in-out both}
    .solsniffer-section .loading-dots span:nth-child(1){animation-delay:-0.32s}
    .solsniffer-section .loading-dots span:nth-child(2){animation-delay:-0.16s}
    @keyframes bounce-dots{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
    .solsniffer-section .typing-cursor{display:inline-block;width:2px;height:18px;background:#000000;margin-left:2px;animation:blink 1s infinite}
    @keyframes blink{0%,49%{opacity:1}50%,100%{opacity:0}}
    .solsniffer-section .summary-box{background:#f8f8f8;border:2px solid #000000;border-radius:12px;padding:20px;margin-top:24px}
    .solsniffer-section .summary-box h4{margin:0 0 12px;font-size:16px;font-weight:800;color:#000000;text-transform:uppercase;letter-spacing:0.5px}
    .solsniffer-section .summary-box p{margin:0;color:#000000;font-size:15px;line-height:1.6}
  </style>

  <h2>üîç Token Rug Pull Analyzer</h2>
  <p class="lead">Enter a Solana token address below. Dobby AI will analyze the token for potential rug pull risks and provide you with a detailed security assessment.</p>

  <div class="controls">
    <input type="text" id="solsnifferAddr" placeholder="Enter Solana token address..." />
    <button id="solsnifferCheck">Analyze Token</button>
    <!--<button id="solsnifferExample" class="ghost">Try Example</button>-->
  </div>

  <div id="solsnifferResult" class="result" role="status" aria-live="polite">
    <div id="solsnifferSummary"></div>
    
    <div id="solsnifferAiAnalysis" class="analysis-section" style="display:none">
      <h3>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        Dobby's Analysis
      </h3>
      <div id="solsnifferAiContent" class="analysis-content"></div>
    </div>
  </div>
</div>

<script>

</script>
</div>

<div class="card">
  <h2>üìù Manual Security Checklist</h2>
  <p class="muted">Until automated rug checking is available, use this checklist when evaluating tokens:</p>
  
  <div style="margin-top: 16px;">
    <div class="kv">
      <div class="k">1. Check Contract Source</div>
      <div class="v"><span class="badge success">Available</span></div>
    </div>
    <div class="kv">
      <div class="k">2. Verify Liquidity Lock</div>
      <div class="v"><span class="badge success">Available</span></div>
    </div>
    <div class="kv">
      <div class="k">3. Review Team & Social</div>
      <div class="v"><span class="badge warning">Coming soon!</span></div>
    </div>
    <div class="kv">
      <div class="k">4. Check Holder Distribution</div>
      <div class="v"><span class="badge warning">Coming soon!</span></div>
    </div>
    <div class="kv">
      <div class="k">5. Analyze Trading Volume</div>
      <div class="v"><span class="badge success">Available</span></div>
    </div>
  </div>
</div>

<script>
  // ====== PAGE ROUTER ======

const routes = {
  'login': {
    html: 'pages/login.html',
    css: 'css/login.css',
    requiresAuth: false,
    init: setupAuthListeners
  },
  'register': {
    html: 'pages/register.html',
    css: 'css/register.css',
    requiresAuth: false,
    init: setupAuthListeners
  },
  'dashboard': {
    html: 'pages/dashboard.html',
    css: 'css/dashboard.css',
    requiresAuth: true,
    init: initDashboard
  },
  'analyze': {
    html: 'pages/analyze.html',
    css: 'css/analyze.css',
    requiresAuth: true,
    init: initAnalyze
  },
  'rugcheck': {
    html: 'pages/rugcheck.html',
    css: 'css/rugcheck.css',
    requiresAuth: true
  },
  'about': {
    html: 'pages/about.html',
    css: 'css/about.css',
    requiresAuth: true
  }
};

let currentPage = null;
let currentCSS = null;

// Navigate to a page
async function navigateTo(page) {
  const route = routes[page];
  
  if (!route) {
    console.error(`Page "${page}" not found`);
    return;
  }
  
  // Check authentication
  if (route.requiresAuth && !currentUser) {
    console.log('Authentication required, redirecting to login');
    navigateTo('login');
    return;
  }
  
  // Unload previous page CSS
  if (currentCSS && currentCSS !== route.css) {
    unloadCSS(currentCSS);
  }
  
  // Load new page CSS
  if (route.css) {
    loadCSS(route.css);
    currentCSS = route.css;
  }
  
  // Load HTML content
  const html = await loadHTML(route.html);
  const container = $('page-container');
  container.innerHTML = html;
  
  // Update navigation
  updateNavigation(page, route.requiresAuth);
  
  // Run page initialization
  if (route.init && typeof route.init === 'function') {
    // Small delay to ensure DOM is ready
    setTimeout(() => {
      try {
        route.init();
        console.log(`Initialized ${page} page`);
      } catch (err) {
        console.error(`Error initializing ${page}:`, err);
      }
    }, 150);
  }
  
  currentPage = page;
  
  // Scroll to top
  window.scrollTo(0, 0);
}

// Update bottom navigation state
function updateNavigation(page, showNav) {
  const bottomNav = $('bottomNav');
  
  // Show/hide navigation
  if (showNav && currentUser) {
    bottomNav.style.display = 'flex';
  } else {
    bottomNav.style.display = 'none';
  }
  
  // Update active state
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.page === page) {
      item.classList.add('active');
    }
  });
}

// Setup navigation listeners
function setupNavigation() {
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
      const page = item.dataset.page;
      if (page) navigateTo(page);
    });
  });
}

// Initialize router on page load
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM loaded, initializing router...');
  setupNavigation();
  checkAuthAndRoute();
});

// Check authentication and route accordingly
async function checkAuthAndRoute() {
  try {
    console.log('Checking authentication...');
    const { data: { session }, error } = await supabase.auth.getSession();
    
    if (error) {
      console.error('Session error:', error);
      navigateTo('login');
      return;
    }
    
    if (session && session.user) {
      console.log('User authenticated:', session.user.email);
      currentUser = session.user;
      await loadUserData();
      navigateTo('dashboard');
    } else {
      console.log('No active session, showing login');
      navigateTo('login');
    }
  } catch (err) {
    console.error('Auth check error:', err);
    navigateTo('login');
  }
}

// Listen for auth state changes
supabase.auth.onAuthStateChange((event, session) => {
  console.log('Auth state changed:', event);
  
  if (event === 'SIGNED_IN' && session) {
    currentUser = session.user;
    loadUserData().then(() => {
      if (currentPage === 'login' || currentPage === 'register') {
        navigateTo('dashboard');
      }
    });
  } else if (event === 'SIGNED_OUT') {
    currentUser = null;
    userData = null;
    navigateTo('login');
  }
});
</script>
